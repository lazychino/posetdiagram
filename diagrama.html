<!DOCTYPE html>
<meta charset="utf-8">
<style>

.link {
  stroke: #ccc;
}

.node text {
  pointer-events: none;
  font: 10px sans-serif;
}

.diagram {
    fill: blue;
}
    
</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>
function DrawAntichain(node,str)
{ 
    str = str.split("|");        
    var k = 0
    for(var i in str)
    {
        for(var j in str[i])
        {
            //~ console.log(i,j);
            k++;
            node.append("circle")
                .attr("class", "diagram")
                .attr("r", 0.4)
                .attr("cx", k-str.length)
                .attr("cy", i);
        }
    }
}


var width = window.innerWidth,
    height = 4000;

var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("currentScale", 0.5);

d3.json("poset.json", function(error, json) {
    
    var link = svg.selectAll(".link")
        .data(json.links)
        .enter().append("line")
        .attr("class", "link")

    var node = svg.selectAll(".node");
    var levels = [];
    var nodesPerLevel = [];
    for(var i in json.nodes) {
        levels[json.nodes[i].level] = levels[json.nodes[i].level] ? (levels[json.nodes[i].level] + 1) : 1;
        if(nodesPerLevel[json.nodes[i].level] === undefined)
          nodesPerLevel[json.nodes[i].level] = [];
        nodesPerLevel[json.nodes[i].level].push(json.nodes[i]);
    }
  
  for(var i in nodesPerLevel) {
    node.data(nodesPerLevel[i])
      .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d, i) {
          return "translate(" + ((((width*0.9) /(levels[d.level]+1)) * ++i))  + "," + ((((levels.length - 1) - d.level)*100) + 50) + ")"; 
      })
      .append("circle")
      .attr("class", "node")
      .attr("r", 7);
   }
   
   svg.selectAll("g").append("text")    
      .attr("dx", "0" )
      .attr("dy", "25")
      .text(function(d) { return d.name });
   
   svg.selectAll("g").each( function(d, i){
        DrawAntichain(d3.select(this), d.name);
        var transform = d3.select(this).attr("transform");
        
        var tmp = transform.split(/\(|\)/);
        coord = tmp[1].split(",");
        //~ console.log(tmp);
        //~ console.log(d.name);
        
        var pos = json.nodes.indexOf(d);
        //~ console.log(json.nodes);
        json.nodes[pos].x = coord[0];
        json.nodes[pos].y = coord[1];
    });
    
    svg.selectAll("g").on("click", function(d) {
        this.parentNode.appendChild(this);
        d3.select(this)
            .attr("big", "true")
            .style("pointer-events", "none")
            .transition()
            .duration(750)
            .attr("transform", "translate(200,200)scale(23)")
            .transition()
            .delay(10000)
            .duration(1000)
            .attr("transform", function(d) {
                return "translate(" + json.nodes[json.nodes.indexOf(d)].x  + "," + json.nodes[json.nodes.indexOf(d)].y + ")";
            });
    });
    
    link.attr("x1", function(d) { return json.nodes[d.source].x; })
        .attr("y1", function(d) { return json.nodes[d.source].y; })
        .attr("x2", function(d) { return json.nodes[d.target].x; })
        .attr("y2", function(d) { return json.nodes[d.target].y; });
  
});

</script>
